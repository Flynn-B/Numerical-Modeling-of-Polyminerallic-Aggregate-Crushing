# Mineralogy map correlation and extrapolation in Python

Obtaining mineralogy maps with XRF scans of a surface is an expensive and slow process. However, obtaining multiple mineralogy maps provides crucial information in microstructure characterization and reconstruction (MCR). In particular, they can act both as:

1. The source of anistropic statistical descriptors used in characterization,
2. Boundary conditions in the reconstruction of a given sample to create more representative microstructures. 

This code aims to extract the color-mineral correlations between a normal RGB image and a XRF scan of a surface. These correlations are then extrapolated and applied to a new surface of the same sample. The result is a 'rough' mineralogy map that is representative of the surface without the cost of a typical XRF scan.

## Installation

Clone the repo

```shell
git clone https://github.com/Flynn-B/Mineralogy-Surface-Analysis-Research.git
```

Install dependencies

```shell
pip install -r requirements.txt
```

## Dependencies

Tested with Python 3.12.5 as well as the following packages:

| package         | version |
| ----            | ----    |
| Numpy           | 2.2.4   |
| Scipy           | 1.15.2  |
| Scikit-image    | 0.24.2  |
| opencv-python   |4.11.0.86|
| matplotlib      | 3.10.1  |

Note, version of Python or packages are likely not strict.

## Getting Started

`Correlate.py` takes two overlapping images. An RGB surface image (`original_img`) and the XRF scan of the same surface (`ideal_img`). These two images have to be as near to perfectly **overlapping** as possible. The input XRF image has to be color-coded in a particular manner. `InitialColorChange.py` is there to make this work easier, although some pre-processing of the XRF image in an external photo editor, such as Photoshop, is likely needed to achieve only a few colors and remove any boundraries if needed. 

The `.pkl` file generated by `Correlate.py` can then be used in `Extrapolate.py` to extrapolate the correlations found and apply them to another surface image of the sample. The generated mineralogy map can then be cropped and rescaled in a manner appropiate for MCR using `CropandScale.py`. 

## Example

For this example, the following surface image and XRF derived mineralogy map will be used:

<p align="center">
  <img src="docs\images\SURFACESample2Section.jpg" style="height:145px;"/>
  <img src="docs\images\XRFSample2.png" style="height:150px;"/>
</p>

The mineralogy map needed minor external pre-processing to remove boundary lines and set to 4 colors. The result is show below:

<p align="center">
  <img src="docs\images\XRFSample2BulkyBiotite.jpg" style="height:150px;"/>
</p>

This is then transfered to an (adjusted) greyscale RGB image using `InitialColorChange.py`. The result of this is shown below:


<p align="center">
  <img src="docs\images\XRFSample2SectionBulkyBiotite.jpg" style="height:150px;"/>
</p>

With the greyscale image and the original surface image, the `.pkl` file containing the color-mineral correlations can be generated. Note, these two images need to be as perfectly as possible **overlapping**. Furthermore, this step to generate the `.pkl` file can be slow if the image is large and contains many unique colors. 

With this file, a `ColorSpace` can be generated from the dictionary. The example `ColorSpace` is shown below:

<p align="center">
  <img src="docs\images\ExampleColorSpace.png" style="height:200px;"/>
</p>

Using the saved `.pkl` file, the correlations found can also be extrapolated and applied using `Extrapolate.py`. This file takes a surface as an input (`applied_img`) and creates a 'rough' mineralogy map. A different surface of the same sample is shown below:

<p align="center">
  <img src="docs\images\Granite4.jpg" style="height:150px;"/>
  <img src="docs\images\Granite4XRF.png" style="height:150px;"/>
</p>

This is typically done for all other surfaces without a mineralogy map.

These results can also be scaled and cropped for better usage in further MCR, such as with [MCRpy](https://github.com/NEFM-TUDresden/MCRpy) created by Paul Seibert at TU Dresden. An example result cropped to 128x128 is show below:

<p align="center">
  <img src="docs\images\128x128Granite4XRF.png" style="height:200px;"/>
</p>